//
// Created by Aditya Bharadwaj on 07/07/23.
//


//RegionAPChuncheon1 region Chuncheon
#define RegionAPChuncheon1 "ap-chuncheon-1"
//RegionAPHyderabad1 region Hyderabad
#define RegionAPHyderabad1 "ap-hyderabad-1"
//RegionAPMelbourne1 region Melbourne
#define RegionAPMelbourne1 "ap-melbourne-1"
//RegionAPMumbai1 region Mumbai
#define RegionAPMumbai1 "ap-mumbai-1"
//RegionAPOsaka1 region Osaka
#define RegionAPOsaka1 "ap-osaka-1"
//RegionAPSeoul1 region Seoul
#define RegionAPSeoul1 "ap-seoul-1"
//RegionAPSydney1 region Sydney
#define RegionAPSydney1 "ap-sydney-1"
//RegionAPTokyo1 region Tokyo
#define RegionAPTokyo1 "ap-tokyo-1"
//RegionCAMontreal1 region Montreal
#define RegionCAMontreal1 "ca-montreal-1"
//RegionCAToronto1 region Toronto
#define RegionCAToronto1 "ca-toronto-1"
//RegionEUAmsterdam1 region Amsterdam
#define RegionEUAmsterdam1 "eu-amsterdam-1"
//RegionFRA region Frankfurt
#define RegionFRA "eu-frankfurt-1"
//RegionEUZurich1 region Zurich
#define RegionEUZurich1 "eu-zurich-1"
//RegionMEJeddah1 region Jeddah
#define RegionMEJeddah1 "me-jeddah-1"
//RegionMEDubai1 region Dubai
#define RegionMEDubai1 "me-dubai-1"
//RegionSASaopaulo1 region Saopaulo
#define RegionSASaopaulo1 "sa-saopaulo-1"
//RegionUKCardiff1 region Cardiff
#define RegionUKCardiff1 "uk-cardiff-1"
//RegionLHR region London
#define RegionLHR "uk-london-1"
//RegionIAD region Ashburn
#define RegionIAD "us-ashburn-1"
//RegionPHX region Phoenix
#define RegionPHX "us-phoenix-1"
//RegionSJC1 region Sanjose
#define RegionSJC1 "us-sanjose-1"
//RegionSAVinhedo1 region Vinhedo
#define RegionSAVinhedo1 "sa-vinhedo-1"
//RegionSASantiago1 region Santiago
#define RegionSASantiago1 "sa-santiago-1"
//RegionILJerusalem1 region Jerusalem
#define RegionILJerusalem1 "il-jerusalem-1"
//RegionEUMarseille1 region Marseille
#define RegionEUMarseille1 "eu-marseille-1"
//RegionAPSingapore1 region Singapore
#define RegionAPSingapore1 "ap-singapore-1"
//RegionMEAbudhabi1 region Abudhabi
#define RegionMEAbudhabi1 "me-abudhabi-1"
//RegionEUMilan1 region Milan
#define RegionEUMilan1 "eu-milan-1"
//RegionEUStockholm1 region Stockholm
#define RegionEUStockholm1 "eu-stockholm-1"
//RegionAFJohannesburg1 region Johannesburg
#define RegionAFJohannesburg1 "af-johannesburg-1"
//RegionEUParis1 region Paris
#define RegionEUParis1 "eu-paris-1"
//RegionMXQueretaro1 region Queretaro
#define RegionMXQueretaro1 "mx-queretaro-1"
//RegionEUMadrid1 region Madrid
#define RegionEUMadrid1 "eu-madrid-1"
//RegionUSChicago1 region Chicago
#define RegionUSChicago1 "us-chicago-1"
//RegionUSLangley1 region Langley
#define RegionUSLangley1 "us-langley-1"
//RegionUSLuke1 region Luke
#define RegionUSLuke1 "us-luke-1"
//RegionUSGovAshburn1 gov region Ashburn
#define RegionUSGovAshburn1 "us-gov-ashburn-1"
//RegionUSGovChicago1 gov region Chicago
#define RegionUSGovChicago1 "us-gov-chicago-1"
//RegionUSGovPhoenix1 gov region Phoenix
#define RegionUSGovPhoenix1 "us-gov-phoenix-1"
//RegionUKGovLondon1 gov region London
#define RegionUKGovLondon1 "uk-gov-london-1"
//RegionUKGovCardiff1 gov region Cardiff
#define RegionUKGovCardiff1 "uk-gov-cardiff-1"
//RegionAPChiyoda1 region Chiyoda
#define RegionAPChiyoda1 "ap-chiyoda-1"
//RegionAPIbaraki1 region Ibaraki
#define RegionAPIbaraki1 "ap-ibaraki-1"
//RegionMEDccMuscat1 region Muscat
#define RegionMEDccMuscat1 "me-dcc-muscat-1"
//RegionAPDccCanberra1 region Canberra
#define RegionAPDccCanberra1 "ap-dcc-canberra-1"
//RegionEUDccMilan1 region Milan
#define RegionEUDccMilan1 "eu-dcc-milan-1"
//RegionEUDccMilan2 region Milan
#define RegionEUDccMilan2 "eu-dcc-milan-2"
//RegionEUDccDublin2 region Dublin
#define RegionEUDccDublin2 "eu-dcc-dublin-2"
//RegionEUDccRating2 region Rating
#define RegionEUDccRating2 "eu-dcc-rating-2"
//RegionEUDccRating1 region Rating
#define RegionEUDccRating1 "eu-dcc-rating-1"
//RegionEUDccDublin1 region Dublin
#define RegionEUDccDublin1 "eu-dcc-dublin-1"
//RegionEUMadrid2 region Madrid
#define RegionEUMadrid2 "eu-madrid-2"
//RegionEUFrankfurt2 region Frankfurt
#define RegionEUFrankfurt2 "eu-frankfurt-2"
//RegionEUJovanovac1 region Jovanovac
#define RegionEUJovanovac1 "eu-jovanovac-1"

/*
var realm = map[string]string{
"oc1":  "oraclecloud.com",
"oc2":  "oraclegovcloud.com",
"oc3":  "oraclegovcloud.com",
"oc4":  "oraclegovcloud.uk",
"oc8":  "oraclecloud8.com",
"oc9":  "oraclecloud9.com",
"oc10": "oraclecloud10.com",
"oc14": "oraclecloud14.com",
"oc19": "oraclecloud.eu",
"oc20": "oraclecloud20.com",
}

var regionRealm = map[Region]string{
RegionAPChuncheon1:    "oc1",
RegionAPHyderabad1:    "oc1",
RegionAPMelbourne1:    "oc1",
RegionAPMumbai1:       "oc1",
RegionAPOsaka1:        "oc1",
RegionAPSeoul1:        "oc1",
RegionAPSydney1:       "oc1",
RegionAPTokyo1:        "oc1",
RegionCAMontreal1:     "oc1",
RegionCAToronto1:      "oc1",
RegionEUAmsterdam1:    "oc1",
RegionFRA:             "oc1",
RegionEUZurich1:       "oc1",
RegionMEJeddah1:       "oc1",
RegionMEDubai1:        "oc1",
RegionSASaopaulo1:     "oc1",
RegionUKCardiff1:      "oc1",
RegionLHR:             "oc1",
RegionIAD:             "oc1",
RegionPHX:             "oc1",
RegionSJC1:            "oc1",
RegionSAVinhedo1:      "oc1",
RegionSASantiago1:     "oc1",
RegionILJerusalem1:    "oc1",
RegionEUMarseille1:    "oc1",
RegionAPSingapore1:    "oc1",
RegionMEAbudhabi1:     "oc1",
RegionEUMilan1:        "oc1",
RegionEUStockholm1:    "oc1",
RegionAFJohannesburg1: "oc1",
RegionEUParis1:        "oc1",
RegionMXQueretaro1:    "oc1",
RegionEUMadrid1:       "oc1",
RegionUSChicago1:      "oc1",

RegionUSLangley1: "oc2",
RegionUSLuke1:    "oc2",

RegionUSGovAshburn1: "oc3",
RegionUSGovChicago1: "oc3",
RegionUSGovPhoenix1: "oc3",

RegionUKGovLondon1:  "oc4",
RegionUKGovCardiff1: "oc4",

RegionAPChiyoda1: "oc8",
RegionAPIbaraki1: "oc8",

RegionMEDccMuscat1: "oc9",

RegionAPDccCanberra1: "oc10",

RegionEUDccMilan1:  "oc14",
RegionEUDccMilan2:  "oc14",
RegionEUDccDublin2: "oc14",
RegionEUDccRating2: "oc14",
RegionEUDccRating1: "oc14",
RegionEUDccDublin1: "oc14",

RegionEUMadrid2:    "oc19",
RegionEUFrankfurt2: "oc19",

RegionEUJovanovac1: "oc20",
}
*/

#ifndef FLB_OUT_OCI_LOGAN_H
#define FLB_OUT_OCI_LOGAN_H

#define FLB_OCI_LOG_ENTITY_ID_KEY "oci_la_entity_id"
#define FLB_OCI_LOG_ENTITY_ID_KEY_SIZE sizeof(FLB_OCI_LOG_ENTITY_ID_KEY) - 1

#define FLB_OCI_LOG_ENTITY_TYPE_KEY "oci_la_entity_type"
#define FLB_OCI_LOG_ENTITY_TYPE_KEY_SIZE sizeof(FLB_OCI_LOG_ENTITY_TYPE_KEY) - 1

#define FLB_OCI_LOG_GROUP_ID_KEY "oci_la_log_group_id"
#define FLB_OCI_LOG_GROUP_ID_KEY_SIZE sizeof(FLB_OCI_LOG_GROUP_ID_KEY) - 1

#define FLB_OCI_LOG_SET_ID_KEY "oci_la_log_set_id"
#define FLB_OCI_LOG_SET_ID_KEY_SIZE sizeof(FLB_OCI_LOG_SET_ID_KEY) - 1

#define FLB_OCI_LOG_SOURCE_NAME_KEY "oci_la_log_source_name"
#define FLB_OCI_LOG_SOURCE_NAME_KEY_SIZE sizeof(FLB_OCI_LOG_SOURCE_NAME_KEY) - 1

#define FLB_OCI_LOG_PATH_KEY "oci_la_log_path"
#define FLB_OCI_LOG_PATH_KEY_SIZE sizeof(FLB_OCI_LOG_PATH_KEY) - 1

#define FLB_OCI_METADATA_KEY "oci_la_metadata"
#define FLB_OCI_METADATA_KEY_SIZE sizeof(FLB_OCI_METADATA_KEY) - 1

#define FLB_OCI_GLOBAL_METADATA_KEY "oci_la_global_metadata"
#define FLB_OCI_GLOBAL_METADATA_KEY_SIZE sizeof(FLB_OCI_GLOBAL_METADATA_KEY) - 1

#define FLB_OCI_LOG_EVENTS  "logEvents"
#define FLB_OCI_LOG_EVENTS_SIZE sizeof(FLB_OCI_LOG_EVENTS)-1

#define FLB_OCI_LOG_RECORDS  "logRecords"
#define FLB_OCI_LOG_RECORDS_SIZE sizeof(FLB_OCI_LOG_RECORDS)-1

#define FLB_OCI_LOG_GROUP_ID "logGroupId"
#define FLB_OCI_LOG_GROUP_ID_SIZE sizeof(FLB_OCI_LOG_GROUP_ID)-1

#define FLB_OCI_ENTITY_TYPE "entityType"
#define FLB_OCI_ENTITY_TYPE_SIZE sizeof(FLB_OCI_ENTITY_TYPE) - 1

#define FLB_OCI_LOG_SET "logSet"
#define FLB_OCI_LOG_SET_SIZE sizeof(FLB_OCI_LOG_SET)-1

#define FLB_OCI_LOG_METADATA "metadata"
#define FLB_OCI_LOG_METADATA_SIZE sizeof(FLB_OCI_LOG_METADATA)-1

#define FLB_OCI_ENTITY_ID "entityId"
#define FLB_OCI_ENTITY_ID_SIZE sizeof(FLB_OCI_ENTITY_ID)-1

#define FLB_OCI_LOG_SOURCE_NAME "logSourceName"
#define FLB_OCI_LOG_SOURCE_NAME_SIZE sizeof(FLB_OCI_LOG_SOURCE_NAME)-1

#define FLB_OCI_LOG_PATH "logPath"
#define FLB_OCI_LOG_PATH_SIZE sizeof(FLB_OCI_LOG_PATH)-1

#define FLB_OCI_META_PREFIX "metadata_"
#define FLB_OCI_META_PREFIX_SIZE sizeof(FLB_OCI_META_PREFIX)-1

#define FLB_OCI_MATCH_PREFIX "oci_match_"
#define FLB_OCI_MATCH_PREFIX_SIZE sizeof(FLB_OCI_MATCH_PREFIX)-1

#ifdef FLB_HAVE_REGEX
#define FLB_OCI_MATCH_REGEX_PREFIX "oci_match_regex_"
#define FLB_OCI_MATCH_REGEX_PREFIX_SIZE sizeof(FLB_OCI_MATCH_REGEX_PREFIX)-1
#endif

/* Params */
#define FLB_OCI_PARAM_SKIP_HTTP_POST "skip_http_post"
#define FLB_OCI_PARAM_URI "uri"
#define FLB_OCI_PARAM_ENABLE_TRACE_OUTPUT "enable_trace"
#define FLB_OCI_PARAM_TRACE_OUTPUT_PATH "trace_file_path"
#define FLB_OCI_PARAM_TRACE_OUTPUT_FILE "trace_file_name"
#define FLB_OCI_PARAM_COLLECT_TIME_FIELD "collect_time_field_name"

#define FLB_OCI_PARAM_USE_RAW_RECORD "use_raw_record"
#define FLB_OCI_PARAM_USE_RAW_RECORD_SIZE sizeof(FLB_OCI_PARAM_USE_RAW_RECORD)-1

#define FLB_OCI_PARAM_INCLUDE_COLLECT_TIME "include_collect_time"
#define FLB_OCI_PARAM_INCLUDE_COLLECT_TIME_SIZE sizeof(FLB_OCI_PARAM_INCLUDE_COLLECT_TIME)-1

#define FLB_OCI_MATCH_ID_MAX 1000 // TO avoid too large memory allocation

#define FLB_OCI_DEFAULT_COLLECT_TIME       "oci_collect_time"
#define FLB_OCI_DEFAULT_COLLECT_TIME_SIZE sizeof(FLB_OCI_DEFAULT_COLLECT_TIME)-1

/* Http Header */
#define FLB_OCI_HEADER_REQUEST_TARGET           "(request-target)"
#define FLB_OCI_HEADER_USER_AGENT                      "User-Agent"
#define FLB_OCI_HEADER_USER_AGENT_VAL                  "Fluent-Bit"
#define FLB_OCI_HEADER_CONTENT_TYPE                    "content-type"
#define FLB_OCI_HEADER_CONTENT_TYPE_VAL                "application/octet-stream"
#define FLB_OCI_HEADER_CONTENT_TYPE_FED_VAL            "application/json"
#define FLB_OCI_HEADER_X_CONTENT_SHA256                "x-content-sha256"
#define FLB_OCI_HEADER_CONTENT_LENGTH                  "content-length"
#define FLB_OCI_HEADER_HOST                            "host"
#define FLB_OCI_HEADER_DATE                            "date"
#define FLB_OCI_HEADER_AUTH                            "Authorization"
#define FLB_OCI_PAYLOAD_TYPE                           "payloadType"
#define INSTANCE_PRINCIPAL                             "instance_principal"
#define USER_PRINCIPAL                                 "user_principal"
#define WORKLOAD_IDENTITY                              "workload_identity"

#define FLB_OKE_DEFAULT_SA_CERT_PATH  "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
#define FLB_OKE_TOKEN_PATH  "/var/run/secrets/kubernetes.io/serviceaccount/token"

/* For OCI signing */
#define FLB_OCI_PARAM_TENANCY     "tenancy"
#define FLB_OCI_PARAM_USER        "user"
#define FLB_OCI_PARAM_KEY_FINGERPRINT     "fingerprint"
#define FLB_OCI_PARAM_KEY_FILE     "key_file"
#define FLB_OCI_PARAM_REGION  "region"
#define FLB_OCI_PARAM_KEY_FILE_PASSPHRASE "key_file_passphrase"

/* For error response */
#define FLB_OCI_ERROR_RESPONSE_CODE     "code"
#define FLB_OCI_ERROR_RESPONSE_MESSAGE  "message"

#define FLB_OCI_ERROR_CODE_RELATED_RESOURCE_NOT_FOUND      "RelatedResourceNotAuthorizedOrNotFound"
#define FLB_OCI_ERROR_CODE_NOT_AUTHENTICATED               "NotAuthenticated"
#define FLB_OCI_ERROR_CODE_NOT_AUTHENTICATEDORNOTFOUND     "NotAuthorizedOrNotFound"
#define FLB_OCI_ERROR_CODE_INCORRECTSTATE                  "IncorrectState"
#define FLB_OCI_ERROR_CODE_NOT_AUTH_OR_RESOURCE_EXIST      "NotAuthorizedOrResourceAlreadyExists"
#define FLB_OCI_ERROR_CODE_TOO_MANY_REQUESTS               "TooManyRequests"
#define FLB_OCI_ERROR_CODE_INTERNAL_SERVER_ERROR           "InternalServerError"

#define OCI_FEDERATION_REQUEST_PAYLOAD            "{\"certificate\":\"%s\",\"publicKey\":\"%s\", \"intermediateCertificates\":[\"%s\"]}"
#define OCI_OKE_PROXYMUX_PAYLOAD                  "{\"podKey\":\"%s\"}"

#define METADATA_HOST_BASE "169.254.169.254"
#define GET_REGION_URL  "/opc/v2/instance/region"
#define GET_REGION_INFO_URL "/opc/v2/instance/regionInfo/"
#define LEAF_CERTIFICATE_URL "/opc/v2/identity/cert.pem"
#define LEAF_CERTIFICATE_PRIVATE_KEY_URL "/opc/v2/identity/key.pem"
#define INTERMEDIATE_CERTIFICATE_URL "/opc/v2/identity/intermediate.pem"


#include <fluent-bit/flb_upstream.h>
#include <fluent-bit/flb_sds.h>
#include <fluent-bit/flb_record_accessor.h>
#include <fluent-bit/flb_hash_table.h>
#include <monkey/mk_core/mk_list.h>
#include "oci_client.h"

struct request_signer {
  flb_sds_t user_id;
  flb_sds_t tenancy_id;
  flb_sds_t region;
  flb_sds_t private_key;
  flb_sds_t key_fingerprint;
  flb_sds_t key_id;
};

struct federation_client {
  struct flb_upstream *u;
  flb_sds_t region;
  flb_sds_t tenancy_id;
  struct cert_retriever *leaf_cert_ret;
  struct cert_retriever *intermediate_cert_ret;
  // session key supplier
  flb_sds_t private_key;
  flb_sds_t public_key;
  flb_sds_t key_id;
  flb_sds_t security_token;
  time_t expire;
  pthread_mutex_t lock;
};

struct cert_retriever {
  struct flb_upstream *u;
  flb_sds_t cert_pem;
  X509 *cert;
  flb_sds_t private_key_pem;
};

struct metadata_obj {
    flb_sds_t key;
    flb_sds_t val;
    struct mk_list _head;

};

struct flb_oci_error_response
{
  flb_sds_t code;
  flb_sds_t message;
};

struct flb_oci_logan {
    flb_sds_t namespace;
    flb_sds_t config_file_location;
    flb_sds_t profile_name;
    int oci_config_in_record;
    flb_sds_t uri;
    flb_sds_t auth_type;

    struct flb_upstream *u;
    flb_sds_t proxy;
    char *proxy_host;
    int proxy_port;

    struct flb_upstream *cert_u;
    struct flb_upstream *fed_u;
    // oci_la_* configs
    flb_sds_t oci_la_entity_id;

    flb_sds_t oci_la_entity_type;

    flb_sds_t oci_la_log_source_name;

    flb_sds_t oci_la_log_path;

    flb_sds_t oci_la_log_group_id;

    flb_sds_t oci_la_log_set_id;

    struct mk_list *oci_la_global_metadata;
    struct mk_list global_metadata_fields;
    struct mk_list *oci_la_metadata;
    struct mk_list log_event_metadata_fields;

  // config_file
    flb_sds_t user;
    flb_sds_t region;
    flb_sds_t tenancy;
    flb_sds_t key_fingerprint;
    flb_sds_t key_file;
    /* For OCI signing */
    flb_sds_t key_id; // tenancy/user/key_fingerprint
    flb_sds_t private_key;
    flb_sds_t oke_sa_ca_file;
    flb_sds_t oke_sa_token_file;

    struct federation_client *fed_client;

    struct flb_hash_table *region_table;

    struct flb_output_instance *ins;

};
#endif
